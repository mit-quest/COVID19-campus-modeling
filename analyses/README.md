# Analyses

## Purpose of `analysis` class
`analyses` files are used to calculate summary statistics from the simulation results that can be then used by the UI (in `frontend/`) for visualization.

Here, we include 4 such `analysis` files:
- `person_analysis`: creates statistics (e.g. age distribution) of demographics from the samples generated by the `person` model
- `building_analysis`: creates statistics (e.g. hourly inflow for building E14) from the samples generated by the `trajectory` model
- `campus_analysis`L creates statistics (e.g. hourly inflow for campus) from the samples generated by the `trajectory` model
- `observations_and_model_distributions`: overlays statistics of sample data with observed data (to be added by you). This is used for predictive checks (model checking)


## Creating new analyses
Create a new folder with your `<analysis_name>`
```sh
$ cd analyses
$ mkdir <analysis_name>
```
Copy the analysis and config templates to your new folder
```sh
$ cp ../common/new_analysis.py <analysis_name>/<analysis_fname>.py
$ cp ../common/new_config.json <analysis_name>/config.json
```
Modify the parameters in `config.json`:
> e.g. `analysis_name`, `analysis_id`, `analysis_pyfile`, `analysis_pyclass`, `input_models`, `analysis_parameters`

Modify the `run` method in `<analysis_fname.py>`
> def run(self, input_samples : dict) -> dict:

Try running the analysis
```sh
$ python run_analysis.py --config-file <config_file> --uuid-prefix <uuid_prefix>
```

If run locally, the analysis output will be written to:
```
local_outputs/analyses/<analysis_name>/<analysis_id>/<uuid_prefix>-<analysis_name>_results.json
local_outputs/analyses/<analysis_name>/<analysis_id>/<uuid_prefix>-<analysis_name>_metadata.json
```

## Important notes
### Config schema validation
Each analysis must include a `config.json` file that adheres to the schema specified in `common/schema/config.schema`

To validate, run
```sh
$ jsonschema -i <config file> common/schema/config.schema
```
### Random seed
If a random generator (e.g. `numpy`, `random`) is used in your analysis, you must use a random seed and define that value in `analysis_parameters` in `config.json`

This ensures that the outputs are reproducible

To test reproducibility, add the analysis config file to one of the `scheduler/scenarios/<scenario_name>.json` files and run the unittests
```sh
$ cd ../
$ python -m unittest
```
